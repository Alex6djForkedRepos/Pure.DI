// ReSharper disable ClassNeverInstantiated.Global
namespace Pure.DI.Core.Code;

internal sealed class ClassBuilder(
    [Tag(typeof(UsingDeclarationsBuilder))] IBuilder<CompositionCode, CompositionCode> usingDeclarationsBuilder,
    [Tag(typeof(FieldsBuilder))] IBuilder<CompositionCode, CompositionCode> fieldsBuilder,
    [Tag(typeof(ArgFieldsBuilder))] IBuilder<CompositionCode, CompositionCode> argFieldsBuilder,
    [Tag(typeof(ParameterizedConstructorBuilder))] IBuilder<CompositionCode, CompositionCode> parameterizedConstructorBuilder,
    [Tag(typeof(DefaultConstructorBuilder))] IBuilder<CompositionCode, CompositionCode> defaultConstructorBuilder,
    [Tag(typeof(ScopeConstructorBuilder))] IBuilder<CompositionCode, CompositionCode> scopeConstructorBuilder,
    [Tag(typeof(RootMethodsBuilder))] IBuilder<CompositionCode, CompositionCode> rootPropertiesBuilder,
    [Tag(typeof(ApiMembersBuilder))] IBuilder<CompositionCode, CompositionCode> apiMembersBuilder,
    [Tag(typeof(DisposeMethodBuilder))] IBuilder<CompositionCode, CompositionCode> disposeMethodBuilder,
    [Tag(typeof(ToStringMethodBuilder))] IBuilder<CompositionCode, CompositionCode> toStringBuilder,
    [Tag(typeof(ResolversFieldsBuilder))] IBuilder<CompositionCode, CompositionCode> resolversFieldsBuilder,
    [Tag(typeof(StaticConstructorBuilder))] IBuilder<CompositionCode, CompositionCode> staticConstructorBuilder,
    [Tag(typeof(ResolverClassesBuilder))] IBuilder<CompositionCode, CompositionCode> resolversClassesBuilder,
    [Tag(typeof(ClassCommenter))] ICommenter<Unit> classCommenter,
    IInformation information,
    CancellationToken cancellationToken)
    : IBuilder<CompositionCode, CompositionCode>
{
    private readonly ImmutableArray<IBuilder<CompositionCode, CompositionCode>> _codeBuilders = ImmutableArray.Create(
        fieldsBuilder,
        argFieldsBuilder,
        parameterizedConstructorBuilder,
        defaultConstructorBuilder,
        scopeConstructorBuilder,
        rootPropertiesBuilder,
        apiMembersBuilder,
        disposeMethodBuilder,
        toStringBuilder,
        resolversFieldsBuilder,
        staticConstructorBuilder,
        resolversClassesBuilder);

    public CompositionCode Build(CompositionCode composition)
    {
        var code = composition.Code;
        code.AppendLine("// <auto-generated/>");
        code.AppendLine($"// by {information.Description}");
        code.AppendLine("#nullable enable");
        code.AppendLine("#pragma warning disable");
        code.AppendLine();

        composition = usingDeclarationsBuilder.Build(composition);
        
        var nsIndent = Disposables.Empty;
        var name = composition.Source.Source.Name;
        if (!string.IsNullOrWhiteSpace(name.Namespace))
        {
            code.AppendLine($"namespace {name.Namespace}");
            code.AppendLine("{");
            nsIndent = code.Indent();
        }
        
        classCommenter.AddComments(composition, Unit.Shared);

        code.AppendLine($"[{Names.SystemNamespace}Diagnostics.CodeAnalysis.ExcludeFromCodeCoverage]");
        var implementingInterfaces = composition.DisposablesCount > 0 ? $": {Names.IDisposableInterfaceName}" : "";
        code.AppendLine($"partial class {name.ClassName}{implementingInterfaces}");
        code.AppendLine("{");

        using (code.Indent())
        {
            // Generate class members
            foreach (var builder in _codeBuilders)
            {
                cancellationToken.ThrowIfCancellationRequested();
                composition = builder.Build(composition);
            }
        }

        code.AppendLine("}");

        // ReSharper disable once InvertIf
        if (!string.IsNullOrWhiteSpace(name.Namespace))
        {
            // ReSharper disable once RedundantAssignment
            nsIndent.Dispose();
            code.AppendLine("}");
        }
        
        code.AppendLine("#pragma warning restore");
        return composition;
    }
}